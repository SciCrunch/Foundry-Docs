# Dispatcher

### Dispatcher

The dispatcher is preconfigured with one or more pipeline definitions to harvest/ingest documents for a source, process/enhance/transform them for indexing. The dispatcher listens to the op-log capped collection of MongoDB for database update events and based on the preconfigured pipeline definitions creates and sends messages to their corresponding message queues. The messages are consumed by consumers coordinated by one or more consumer heads. Each step in a pipeline is handled by a specific consumer. When a consumer finishes the processing of a document it sets the document status to a preconfigured value indicative of the next step in the pipeline and saves the document back to the MongoDB. This creates an op-log activity, which triggers the dispatcher. If the pipeline definition has a route from the current document status to a message queue, indicative of further pipeline processing another message is generated by the dispatcher and put to the message queue indicated by the route. This triggers the corresponding consumer on one of the consumer heads. The persistent message queues deliver each message only once. Thus, if more than one consumer head is listening on the same message queue, only one of them will process the document identified by the message as desired.

#### Dispatcher Configuration

The dispatcher is configured via the `dispatcher-cfg.xml` file residing in `$FOUNDRY_HOME/dispatcher/src/main/resources`.

```markup
    <dispatcher-cfg>
       <mongo-config db="discotest" collection="records">
         <servers>
            <server host="burak.crbs.ucsd.edu" port="27017"/>
            <server host="burak.crbs.ucsd.edu" port="27018"/>
         </servers>
       </mongo-config>
       <activemq-config>
          <brokerURL>tcp://localhost:61616</brokerURL>
       </activemq-config>
       <checkpoint-file>/var/burak/foundry/mongo-dispatcher-cp.xml</checkpoint-file>
       <queues>
           <queue name="foundry.indexCheckpoint" headerFields="History.batchId,SourceInfo.SourceID"></queue>
      </queues>
      <routes>
         <route>
            <condition>
                <predicate name="processing.status" op="eq" value="new"/>
            </condition>
            <to>foundry.new</to>
         </route>
         <route>
            <condition>
                <predicate name="processing.status" op="eq" value="index_cp"/>
            </condition>
            <to>foundry.indexCheckpoint</to>
         </route>
         <route>
            <condition>
                <predicate name="processing.status" op="eq" value="index"/>
            </condition>
            <to>foundry.index</to>
         </route>
      </routes>
    </dispatcher-cfg>
```

